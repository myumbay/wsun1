{% extends 'WsunBundle:Default:index.html.twig'%}

{% block bloque1 %}
    
<div class="box">
     <div class="panel panel-azul">

 {% for detalle in det %}
     {{dump(detalle.idProducto.producto.id)}}
 {% endfor %}
<table class="table table-bordered table-hover table-striped head-fixed table-condensed2">
    <thead>
    <tr>
        <th width="150" class="center"><input type="checkbox" id="seleccionarTodos"/>  Seleccionar</th>
        <th>Producto</th>
        <th>Cantidad</th>
        <th>Precio U.</th>
        <th>Iva.</th>
        <th>Valor T.</th>
    </tr>
    </thead>
    <tbody id="tablaProducts">
        {% set contador = 1 %}
       
        {% for producto in productos %}
        <tr>
        {% set idp=0%}
                {% set cantidad=''%}
                {% set vu=''%}
                {% set vt=''%}
                {% set iv=''%}
        {% for detalle in det %}
            {% if(detalle.idProducto.producto.id== producto.producto.id)%}
                {% set idp=1%}
                {% set cantidad=detalle.cantidad%}
                {% set iv=detalle.observaciones%}
                {% set vt=detalle.valortotal%}
              
                  
            {% endif %}
        {% endfor %}
        {%if (idp==1) %}
            <td class="text-center"><input class="selProducto" type="checkbox" name="productos[{{ producto.id }}][id]" value="{{ producto.id }}" checked/>
            </td>
        {%else%}
            <td class="text-center"><input class="selProducto" type="checkbox" name="productos[{{ producto.id }}][id]" value="{{ producto.id }}"/>
            </td>
        {% endif %}
            <td style="vertical-align: middle;"><strong>{{ contador }}.- </strong>  {{ producto.producto.nombreProducto }} {{ (producto.producto.estado == '0') ? '<span class="text-danger"><strong>(INACTIVO)</strong></span>' : '' }}</td>
            <td><input type="text" class="form-control input-sm cantidad" id="cantidad{{ producto.id }}" name="productos[{{ producto.id }}][cantidad]" value="{{cantidad}}"/></td>
            <td style="vertical-align: middle;"> 
            <input type="text" class="form-control input-sm preciounit" id="preciounit{{ producto.id }}" name="productos[{{ producto.id }}][preciounit]" value="{{ producto.producto.PrecioProducto }}" readonly/>
            </td>
            <td>
                <SELECT class="selProducto" id="iva{{ producto.id }}" name="productos[{{ producto.id }}][iva]" size=1 onChange="calc(this.value,{{ producto.id }});"> 
                    <OPTION value="">--</OPTION>
                    {% if(iv=='')%}
                    <OPTION value="0">0%</OPTION>
                    <OPTION value="12">12</OPTION>
                    {%else%}
                        {% if (iv==0)%}
                        <OPTION value="0" selected:selected>0%</OPTION>
                        {% else%}
                        <OPTION value="12" selected:selected>12</OPTION>
                        {% endif %}
                    {% endif%}
                    
                </SELECT>
            </td>
            <td><input type="text" class="form-control input-sm preciounit" id="valortotal{{ producto.id }}" name="productos[{{ producto.id }}][valortotal]" readonly value="{{vt}}" /></td>
           
              
        </tr>
        {% set contador = contador + 1 %}
    {% else %}
        <tr>
            <td colspan="3">
                No se encontraron resultados
            </td>
        </tr>
    {% endfor %}
    </tbody>
</table>
     <div id="respuesta" style="border:1px red  ">
       
     </div>    
                        
                    </tbody>
     </div>
     <span class="input-group-btn">
    <button id="btnGuardarEmpresa" class="btn btn-success" type="button" onclick="guardar();
    return false;">Guardar</button></span> 
    <a href="{{ path('pedido_index') }}" ><i class="fa fa-camera-retro fa-lg" aria-hidden="true"></i> Back to the list</a>
</div>
{%endblock%}
{% block javascripts %}
    {{ parent() }}

    <script type="text/javascript">
        $(document).ready(function () {
            
           $('span').click(function(){
                $('#InputToFocus').focus();
            });
            $("#seleccionarTodos").click(function() {
            if ($(this).is(':checked')) {
                $(".selProducto").prop("checked", true);
            }else{
                $(".selProducto").prop("checked", false);
            }
        });
            {#$('.typeahead.empresa').autocomplete(
                    {
                        minChars: 3,
                        serviceUrl: '{{ path('wsun_empresa_autocomplete') }}',
                        onSelect: function(suggestion) {
                             $id_convenio = suggestion.data;
                            $('#empresaId').val($id_convenio);
                            //$("#div_producto").hide();
                             $("#btnGuardarEmpresa").prop('disabled', false);
                        }
                        ,
                        autoSelect: true,
                       
                        autoFocus: true,
                        appendTo: '#autocomplete_container_empresa'
                    }
            );#}
        });
{#       var limpiarEmpresa = function(){
            $("#ruc").val('');
            $('#empresaId').val('');
            $("#ruc").prop('disabled',false);
            $("#btnBuscarEmpresa").prop('disabled', true);

        }
        var aceptar_convenio = function() {
            if ($('#empresaId').val() == ''){
                alert("Por favor, seleccione una Empresa");
                return false;
            }
            var id_empresa = $('#empresaId').val();
            document.location.href = "{{path('admin_productos_empresa_index',{'id' : id_empresa |default('1')})}}";
    
        }#}
        
        var validarProductos = function () {
            var banCapacidadproductiva = true;
             
         
            if ($('#tablaProducts input[type=checkbox]:checked').length ==0){
                alert('Seleccione un producto');
                return false;
            }
            
            
            $('#tablaProducts input[type=checkbox]:checked').each(function () {
                     
                   var idProducto = $(this).val();
                   
                    if ($('#cantidad' + idProducto).val() == '') {
                        alert('Ingrese la cantidad');
                        $('#cantidad' + idProducto).focus();
                        banCapacidadproductiva = false;
                        return false;
                    } else if (isNaN($('#cantidad' + idProducto).val()) || $('#cantidad' + idProducto).val() % 1 != 0) {
                        alert('Ingrese solo n√∫meros enteros.');
                        $('#cantidad' + idProducto).focus();
                        banCapacidadproductiva = false;
                        return false;
                    } 
                    else if (!parseInt($('#cantidad' + idProducto).val())) {
                        alert('Ingrese capacidad Productiva');
                        $('#cantidad' + idProducto).val('');
                        $('#cantidad' + idProducto).focus();
                        banCapacidadproductiva = false;
                        return false;
                    } if ($('#iva' + idProducto).val() == '') {
                        alert('Seleccione el Iva');
                        $('#iva' + idProducto).focus();
                        banCapacidadproductiva = false;
                        return false;
                    }
                });
                
                if (!banCapacidadproductiva) {
                    return false;
                }
                
            return true;
        };
        function calc(iva,id){
            if(iva!= '')
            {
                var iva=$('#iva'+id).val();
                var cantidad=$('#cantidad'+id).val();
                var precio=$('#preciounit'+id).val();
               
                var total= cantidad*precio+((cantidad*precio)*iva/100);
                 
                $('#valortotal'+id).val(total);
            }
          else alert('Seleccione un valor valido');
        }
        var guardar = function () {
            if (!validarProductos()){
                return false;
            }
            var pedido_id= {{idPedido}};
            
            var producto = '';
            var capacidades= '';
            var ivas= '';
            var pu= '';
            var vt= '';
             $('#tablaProducts input[type=checkbox]:checked').each(function () {
                var idProducto = $(this).val();
                var cantidad = $('#cantidad' + idProducto).val();
                var iva = $('#iva' + idProducto).val();
                var preciou = $('#preciounit' + idProducto).val();
                var valott = $('#valortotal' + idProducto).val();
                producto +=  idProducto+',';
                capacidades+= (cantidad?cantidad:'--')+',';
                ivas+= (iva?iva:'--')+',';
                pu+= (preciou?preciou:'--')+',';
                vt+= (valott?valott:'--')+',';
                
                
            });
            producto = producto.slice(0,-1);
            capacidades = capacidades.slice(0,-1);
            ivas = ivas.slice(0,-1);
            pu = pu.slice(0,-1);
            vt = vt.slice(0,-1);
           
            var contador = 1;
            var errores=0;
            $.ajax({
                    async:false,
                    complete: function(xhr, data)
                    {
                        if (xhr.responseText.search('<head class="login">') < 50 && xhr.responseText.search('<head class="login">') != - 1){
                            location.reload();
                        }
                    },
                   
                    method: 'POST',
                    data: { 'ids_productos':producto,  'pedido_id':pedido_id, 'capacidades':capacidades,'ivas':ivas,'pu':pu,'vt':vt },
                    url: "{{ path('guarda_detalle_pedido')}}", 
                    context: document.body 
                }).done(function(dataJson) {
                   //
                   if (dataJson['error']==1){
                        $('#respuesta').html('<strong style="color:green;">'+dataJson['mensaje']+'</strong>');
                        errores=1;
                    } else if(dataJson['error']==0){
                        $('#respuesta').html('<strong style="color:red;">'+dataJson['mensaje']+'</strong>');
                        window.location = "{{path('detallepedido_index',{'id':idPedido})}}"
                        //$('#respuesta').append('<tr><td width="100">'+contador+'</td><td><div>'+dataJson['mensaje']+'</div></td></tr>');
                    }   
                    contador += 1;
                });
                if (errores){
                    return false;
                }
        }; 
       var aceptar_empresa = function() {
        }
        </script>
{%endblock%}